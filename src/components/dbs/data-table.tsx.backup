"use client";

import React, { useState, useCallback } from 'react';
import { cn } from '@/lib/utils';
import { ColumnFilterPopover, ActiveFilters, QuickFilterButton, type ColumnFilter } from './smart-column-filter';
import { Button } from '@/components/ui/button';
import { MousePointer2, GripVertical } from 'lucide-react';

interface DataColumn {
  name: string;
  type: string;
}

type ColumnWidthMode = 'auto' | 'uniform' | 'content-fit';

interface DataTableProps {
  columns: DataColumn[];
  rows: Record<string, any>[];
  className?: string;
  currentPage?: number;
  pageSize?: number;
  totalRows?: number;
  dbId?: string;
  schemaId?: string;
  tableId?: string;
  onFilterChange?: (filters: ColumnFilter[]) => void;
  filters?: ColumnFilter[]; // Add this to sync filters from parent
  widthMode?: ColumnWidthMode; // New prop for controlling column width behavior
}

export function DataTable({ columns, rows, className, currentPage, pageSize, totalRows, dbId, schemaId, tableId, onFilterChange, filters: parentFilters, widthMode = 'auto' }: DataTableProps) {
  const [filters, setFilters] = useState<ColumnFilter[]>(parentFilters || []);
  const [selectedCell, setSelectedCell] = useState<{column: string, value: string} | null>(null);
  const [columnWidths, setColumnWidths] = useState<Record<string, number>>({});
  const [isResizing, setIsResizing] = useState(false);

  // INSTANT width initialization - zero delay startup
  React.useEffect(() => {
    // Synchronous width calculation - no async operations
    const calculateInstantWidths = (): Record<string, number> => {
      // Try saved widths first (only for auto mode)
      if (widthMode === 'auto' && dbId && schemaId && tableId) {
        try {
          const saved = localStorage.getItem(`table-widths-${dbId}-${schemaId}-${tableId}`);
          if (saved) return JSON.parse(saved);
        } catch (e) {
          // Ignore and continue
        }
      }

      const widths: Record<string, number> = {};
      
      // Ultra-fast calculations based on mode
      if (widthMode === 'uniform') {
        // Equal width - instant calculation
        const uniformWidth = Math.max(150, Math.min(250, 800 / columns.length));
        columns.forEach(col => { widths[col.name] = uniformWidth; });
      } else if (widthMode === 'content-fit') {
        // Fast content-based sizing - minimal sampling
        columns.forEach(col => {
          const headerLen = col.name.length;
          const sampleLen = rows.length > 0 ? String(rows[0][col.name] || '').length : 5;
          const maxLen = Math.max(headerLen, sampleLen);
          widths[col.name] = Math.min(Math.max(maxLen * 8 + 60, 120), 350);
        });
      } else {
        // Auto mode - smart defaults
        columns.forEach(col => {
          const baseWidth = Math.max(col.name.length * 7, 80);
          const typeBonus = ['integer', 'float', 'number'].includes(col.type) ? 20 : 40;
          widths[col.name] = Math.min(Math.max(baseWidth + typeBonus, 120), 280);
        });
      }
      
      return widths;
    };

    // Set widths immediately - no delays
    setColumnWidths(calculateInstantWidths());
  }, [columns, dbId, schemaId, tableId, widthMode, rows]);

  // Sync filters with parent when parent filters change
  React.useEffect(() => {
    if (parentFilters) {
      setFilters(parentFilters);
    }
  }, [parentFilters]);

  // Save column widths to localStorage (only for auto mode)
  const saveColumnWidths = useCallback((widths: Record<string, number>) => {
    if (dbId && schemaId && tableId && widthMode === 'auto') {
      localStorage.setItem(`table-widths-${dbId}-${schemaId}-${tableId}`, JSON.stringify(widths));
    }
  }, [dbId, schemaId, tableId, widthMode]);

  // âš¡ LIGHTNING FAST column resize - Google Sheets speed
  const handleResizeStart = useCallback((e: React.MouseEvent, column: string) => {
    e.preventDefault();
    e.stopPropagation();
    
    const startX = e.clientX;
    const startWidth = columnWidths[column] || 120;
    const headerElement = (e.target as HTMLElement).closest('th');
    if (!headerElement) return;
    
    // Cache ALL elements upfront - ZERO DOM queries during drag
    const columnIndex = Array.from(headerElement.parentElement?.children || []).indexOf(headerElement);
    const table = headerElement.closest('table')!;
    const cells = [headerElement, ...table.querySelectorAll(`tbody tr td:nth-child(${columnIndex + 1})`)];
    
    setIsResizing(true);
    let currentWidth = startWidth;
    
    // âš¡ INSTANT width update - pure DOM manipulation
    const updateWidthInstantly = (width: number) => {
      const w = `${width}px`;
      // Single loop, direct property access - fastest possible
      for (let i = 0, len = cells.length; i < len; i++) {
        const style = (cells[i] as HTMLElement).style;
        style.width = style.minWidth = style.maxWidth = w;
      }
    };
    
    // âš¡ ZERO-OVERHEAD mouse handler
    const onMouseMove = (e: MouseEvent) => {
      currentWidth = Math.max(80, startWidth + e.clientX - startX);
      updateWidthInstantly(currentWidth); // Direct call - INSTANT
    };
    
    // âš¡ FAST cleanup
    const onMouseUp = () => {
      setIsResizing(false);
      document.removeEventListener('mousemove', onMouseMove, true);
      document.removeEventListener('mouseup', onMouseUp, true);
      
      // React update AFTER resize (non-blocking)
      setTimeout(() => setColumnWidths(prev => {
        const newWidths = { ...prev, [column]: currentWidth };
        if (widthMode === 'auto' && dbId && schemaId && tableId) {
          localStorage.setItem(`table-widths-${dbId}-${schemaId}-${tableId}`, JSON.stringify(newWidths));
        }
        return newWidths;
      }), 0);
    };
    
    // Use capture for maximum speed
    document.addEventListener('mousemove', onMouseMove, true);
    document.addEventListener('mouseup', onMouseUp, true);
  }, [columnWidths, widthMode, dbId, schemaId, tableId]);

  // âš¡ LIGHTNING auto-resize - INSTANT like Google Sheets
  const handleResizeDoubleClick = useCallback((e: React.MouseEvent, columnName: string) => {
    e.preventDefault();
    e.stopPropagation();
    
    const column = columns.find(c => c.name === columnName);
    if (!column) return;
    
    const headerElement = (e.target as HTMLElement).closest('th');
    if (!headerElement) return;
    
    // âš¡ Cache elements ONCE
    const columnIndex = Array.from(headerElement.parentElement?.children || []).indexOf(headerElement);
    const table = headerElement.closest('table')!;
    const cells = [headerElement, ...table.querySelectorAll(`tbody tr td:nth-child(${columnIndex + 1})`)];
    
    // âš¡ FASTEST width calculation - pure estimation
    let maxWidth = column.name.length * 8 + 50; // Header base
    
    // Lightning fast - check max 5 cells for instant response
    for (let i = 1; i < Math.min(6, cells.length); i++) {
      const text = cells[i].textContent || '';
      maxWidth = Math.max(maxWidth, text.length * 7 + 24);
    }
    
    // Constrain and optimize
    const width = Math.min(Math.max(maxWidth, 100), 600);
    const w = `${width}px`;
    
    // âš¡ INSTANT DOM update - single loop
    for (let i = 0, len = cells.length; i < len; i++) {
      const style = (cells[i] as HTMLElement).style;
      style.width = style.minWidth = style.maxWidth = w;
    }
    
    // Non-blocking React update
    setTimeout(() => setColumnWidths(prev => {
      const newWidths = { ...prev, [column.name]: width };
      if (widthMode === 'auto' && dbId && schemaId && tableId) {
        localStorage.setItem(`table-widths-${dbId}-${schemaId}-${tableId}`, JSON.stringify(newWidths));
      }
      return newWidths;
    }), 0);
        return newWidths;
      });
    });
  }, [columns, widthMode, dbId, schemaId, tableId]);

  // Handle cell double-click for auto-resize - instant response
  const handleCellDoubleClick = useCallback((e: React.MouseEvent, columnName: string) => {
    // Only trigger if double-clicking near the right edge of the cell
    const cellElement = e.currentTarget as HTMLElement;
    const rect = cellElement.getBoundingClientRect();
    const clickX = e.clientX;
    const cellRightEdge = rect.right;
    
    // If clicked within 20px of right edge, auto-resize instantly
    if (cellRightEdge - clickX <= 20) {
      handleResizeDoubleClick(e, columnName);
    }
  }, [handleResizeDoubleClick]);

  const handleAddFilter = (filter: ColumnFilter) => {
    const newFilters = filters.filter(f => f.column !== filter.column);
    newFilters.push(filter);
    setFilters(newFilters);
    onFilterChange?.(newFilters);
  };

  const handleRemoveFilter = (columnName: string) => {
    const newFilters = filters.filter(f => f.column !== columnName);
    setFilters(newFilters);
    onFilterChange?.(newFilters);
  };

  const handleClearAllFilters = () => {
    setFilters([]);
    onFilterChange?.([]);
  };

  const handleCellClick = (column: DataColumn, value: any) => {
    const stringValue = value === null || value === undefined ? '' : String(value);
    const displayValue = stringValue === '' ? 'NULL' : stringValue;
    
    // Quick filter on cell click
    const filter: ColumnFilter = {
      column: column.name,
      operator: stringValue === '' ? 'is_null' : 'equals',
      value: stringValue,
      displayValue
    };
    
    handleAddFilter(filter);
    setSelectedCell({ column: column.name, value: stringValue });
  };
  // Calculate optimal column width based on content
  const getColumnWidth = (column: DataColumn) => {
    return columnWidths[column.name] || 120;
  };

  const formatCellValue = (value: any): string => {
    if (value === null || value === undefined) {
      return '';
    }
    if (typeof value === 'boolean') {
      return value ? 'âœ“' : 'âœ—';
    }
    if (typeof value === 'number') {
      // Format numbers with appropriate precision
      if (Number.isInteger(value)) {
        return value.toLocaleString();
      }
      return parseFloat(value.toFixed(4)).toString();
    }
    if (typeof value === 'string' && value.length > 100) {
      return value.substring(0, 97) + '...';
    }
    return String(value);
  };

  const getTypeIcon = (type: string) => {
    switch (type) {
      case 'integer':
      case 'float':
        return '123';
      case 'boolean':
        return 'T/F';
      case 'timestamp':
      case 'date':
      case 'timestamptz':
        return 'ðŸ“…';
      default:
        return 'Aa';
    }
  };

  const getTypeColor = (type: string) => {
    switch (type) {
      case 'integer':
      case 'float':
        return 'text-blue-600 dark:text-blue-400';
      case 'boolean':
        return 'text-green-600 dark:text-green-400';
      case 'timestamp':
      case 'date':
      case 'timestamptz':
        return 'text-purple-600 dark:text-purple-400';
      default:
        return 'text-gray-600 dark:text-gray-400';
    }
  };

  const getCellAlignment = (column: DataColumn) => {
    if (['integer', 'float'].includes(column.type)) {
      return 'text-right';
    }
    if (column.type === 'boolean') {
      return 'text-center';
    }
    return 'text-left';
  };

  return (
    <div className={cn("relative border border-border rounded-md w-full h-full flex flex-col", className, isResizing && "cursor-col-resize")}>
      {/* Active Filters */}
      <ActiveFilters 
        filters={filters}
        onRemoveFilter={handleRemoveFilter}
        onClearAll={handleClearAllFilters}
      />

      {/* Table container with both horizontal and vertical scroll */}
      <div className={cn("flex-1 overflow-auto w-full", isResizing && "select-none")}>
        <div className="min-w-full">
          <table className="w-max border-collapse bg-background">
            {/* Header - sticky */}
            <thead className="sticky top-0 z-10 bg-background border-b border-border">
              <tr>
                {/* Row number header */}
                <th 
                  style={{ minWidth: '48px', maxWidth: '48px' }}
                >
                  #
                </th>
                {columns.map((column) => (
                  <th
                    key={column.name}
                    className="h-9 px-3 text-xs font-medium text-muted-foreground bg-background border-r border-border last:border-r-0 truncate hover:bg-muted/60 transition-colors whitespace-nowrap group relative"
                    style={{ 
                      width: `${getColumnWidth(column)}px`,
                      minWidth: `${getColumnWidth(column)}px`,
                      maxWidth: `${getColumnWidth(column)}px`
                    }}
                    title={`${column.name} (${column.type}) - Drag right edge to resize, double-click edge to auto-fit`}
                  >
                    <div className="flex items-center gap-1 justify-between w-full">
                      <span className="truncate font-medium">{column.name}</span>
                      <div className="flex items-center gap-1">
                        <span className={cn("text-xs opacity-70 font-mono", getTypeColor(column.type))}>
                          {getTypeIcon(column.type)}
                        </span>
                        {/* Filter button - visible on column header hover */}
                        <div className="opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                          <ColumnFilterPopover
                            column={column}
                            dbId={dbId || 'primary'}
                            schemaId={schemaId || ''}
                            tableId={tableId || ''}
                            currentFilters={filters}
                            onAddFilter={handleAddFilter}
                            onRemoveFilter={handleRemoveFilter}
                            onClearAllFilters={handleClearAllFilters}
                          />
                        </div>
                      </div>
                    </div>
                    
                    {/* Resize handle - only enabled for auto mode */}
                    {widthMode === 'auto' && (
                      <div 
                        className={cn(
                          "absolute top-0 right-0 w-2 h-full cursor-col-resize hover:bg-primary/30 transition-all duration-200 group-hover:bg-border/30 border-l border-transparent hover:border-primary/50",
                          isResizing && "bg-primary/50 border-primary"
                        )}
                        onMouseDown={(e) => handleResizeStart(e, column.name)}
                        onDoubleClick={(e) => handleResizeDoubleClick(e, column.name)}
                        title="Drag to resize | Double-click to auto-fit content"
                      >
                        <div className="w-full h-full flex items-center justify-center">
                          <div className="w-0.5 h-4 bg-muted-foreground/20 group-hover:bg-muted-foreground/50 hover:bg-primary/70 transition-colors rounded-full" />
                        </div>
                      </div>
                    )}
                  </th>
                ))}
              </tr>
            </thead>

            {/* Body */}
            <tbody>
              {rows.map((row, rowIndex) => {
                // Calculate actual row number based on pagination
                const actualRowNumber = currentPage && pageSize 
                  ? (currentPage - 1) * pageSize + rowIndex + 1 
                  : rowIndex + 1;
                
                return (
                  <tr 
                    key={rowIndex}
                    className="border-b border-border hover:bg-muted/30 transition-colors group"
                  >
                    {/* Row number */}
                    <td 
                      className="w-12 h-8 px-2 text-xs text-muted-foreground bg-muted border-r border-border sticky left-0 z-10 group-hover:bg-muted/80 transition-colors"
                      style={{ minWidth: '48px', maxWidth: '48px' }}
                    >
                      {actualRowNumber.toLocaleString()}
                    </td>
                    {columns.map((column) => {
                      const cellValue = formatCellValue(row[column.name]);
                      const rawValue = row[column.name];
                      const isEmpty = !cellValue;
                      const isSelected = selectedCell?.column === column.name && 
                        String(selectedCell?.value) === String(rawValue === null || rawValue === undefined ? '' : rawValue);
                      
                      return (
                        <td
                          key={column.name}
                          className={cn(
                            "h-8 px-3 text-xs border-r border-border last:border-r-0 truncate whitespace-nowrap",
                            getCellAlignment(column),
                            isEmpty && "text-muted-foreground italic",
                            "hover:bg-accent/20 transition-colors cursor-pointer",
                            isSelected && "bg-primary/20 ring-1 ring-primary/50",
                            "group relative"
                          )}
                          style={{ 
                            width: `${getColumnWidth(column)}px`,
                            minWidth: `${getColumnWidth(column)}px`,
                            maxWidth: `${getColumnWidth(column)}px`
                          }}
                          title={`Click to filter by: ${cellValue || 'NULL'}${widthMode === 'auto' ? ' | Double-click right edge to auto-resize' : ''}`}
                          onClick={() => handleCellClick(column, rawValue)}
                          onDoubleClick={widthMode === 'auto' ? (e) => handleCellDoubleClick(e, column.name) : undefined}
                        >
                          <div className="flex items-center gap-1">
                            <span className="truncate flex-1">
                              {isEmpty ? 'NULL' : cellValue}
                            </span>
                            <MousePointer2 className="h-3 w-3 opacity-0 group-hover:opacity-50 transition-opacity" />
                          </div>
                        </td>
                      );
                    })}
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>

      {/* Empty state */}
      {rows.length === 0 && (
        <div className="flex-1 flex items-center justify-center text-muted-foreground">
          <div className="text-center">
            <div className="text-4xl mb-3">ðŸ“Š</div>
            <p className="text-lg font-medium mb-1">No data found</p>
            <p className="text-sm">This table appears to be empty or no rows match your query.</p>
          </div>
        </div>
      )}

      {/* Row count indicator - fixed at bottom */}
      <div className="px-4 py-2 text-xs text-muted-foreground bg-muted/30 border-t border-border flex items-center justify-between flex-shrink-0">
        <span>
          {rows.length.toLocaleString()} row{rows.length !== 1 ? 's' : ''} Ã— {columns.length} column{columns.length !== 1 ? 's' : ''} on this page
          {totalRows && (
            <span className="ml-2 text-foreground font-medium">
              (Total: {totalRows.toLocaleString()} rows)
            </span>
          )}
        </span>
        {rows.length > 0 && (
          <span className="text-xs opacity-70">
            Scroll horizontally to see more columns â†’
          </span>
        )}
      </div>
    </div>
  );
}
